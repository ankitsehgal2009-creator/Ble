<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cryostat Microtome — nRF51822 BLE Dashboard</title>
  <style>
    body {
      font-family: Inter, ui-sans-serif;
      background: #0f1724;
      color: #e6eef8;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    header {
      width: 100%;
      max-width: 1200px;
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo div {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, #22c55e, #06b6d4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }
    main {
      width: 100%;
      max-width: 1200px;
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.03);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    button {
      background: linear-gradient(90deg, #22c55e, #06b6d4);
      border: none;
      border-radius: 8px;
      color: white;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    .switch-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: #444;
      border-radius: 50px;
      cursor: pointer;
      transition: 0.3s;
    }
    .switch::before {
      content: "";
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: 0.3s;
    }
    .switch.on {
      background: linear-gradient(90deg, #22c55e, #06b6d4);
    }
    .switch.on::before {
      left: 26px;
    }
    .status {
      margin-top: 8px;
      color: #94a3b8;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><div>CM</div><h2>Cryostat Microtome</h2></div>
    <div class="switch-container">
      <div id="bleSwitch" class="switch" role="switch" aria-checked="false"></div>
      <span id="bleStatus" class="status">BLE Disconnected</span>
    </div>
  </header>

  <main>
    <div class="card">
      <h3>Device Status</h3>
      <p>Power: <span id="power">OFF</span></p>
      <p>Mode: <span id="mode">IDLE</span></p>
      <p>Temperature: <span id="temp">— °C</span></p>
      <div class="controls">
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <button id="readTemp">Read Temp</button>
      </div>
    </div>
    <div class="card">
      <h3>Logs</h3>
      <div id="logs" style="height:200px;overflow:auto;background:rgba(0,0,0,0.2);padding:8px;border-radius:8px;font-family:monospace;font-size:13px"></div>
    </div>
  </main>

  <script>
    const bleSwitch = document.getElementById('bleSwitch');
    const bleStatus = document.getElementById('bleStatus');
    const logs = document.getElementById('logs');
    let bleConnected = false;
    let device = null;
    let server = null;
    let uartService = null;
    let txCharacteristic = null; // Notify from device → web
    let rxCharacteristic = null; // Write from web → device

    // Correct Nordic UART Service UUIDs
    const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const UART_RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
    const UART_TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logs.innerHTML = `[${t}] ${msg}<br>` + logs.innerHTML;
    }

    async function connectBLE() {
      try {
        log('Requesting nRF51822 BLE device...');
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [UART_SERVICE_UUID] }]
        });
        log(`Connecting to ${device.name || 'Cryostat'}...`);
        server = await device.gatt.connect();
        uartService = await server.getPrimaryService(UART_SERVICE_UUID);

        rxCharacteristic = await uartService.getCharacteristic(UART_RX_CHAR_UUID);
        txCharacteristic = await uartService.getCharacteristic(UART_TX_CHAR_UUID);

        await txCharacteristic.startNotifications();
        txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

        bleConnected = true;
        bleSwitch.classList.add('on');
        bleSwitch.setAttribute('aria-checked', true);
        bleStatus.textContent = 'BLE Connected';
        log('Connected to nRF51822 successfully');

        device.addEventListener('gattserverdisconnected', onDisconnected);
      } catch (err) {
        log('BLE connection failed: ' + err);
        bleConnected = false;
        bleSwitch.classList.remove('on');
        bleStatus.textContent = 'BLE Disconnected';
      }
    }

    function disconnectBLE() {
      if (device && device.gatt.connected) {
        log('Disconnecting BLE...');
        device.gatt.disconnect();
      }
      bleConnected = false;
      bleSwitch.classList.remove('on');
      bleSwitch.setAttribute('aria-checked', false);
      bleStatus.textContent = 'BLE Disconnected';
      log('BLE disconnected');
    }

    function onDisconnected() {
      log('BLE device lost connection');
      bleConnected = false;
      bleSwitch.classList.remove('on');
      bleStatus.textContent = 'BLE Disconnected';
    }

    function handleNotifications(event) {
      const value = new TextDecoder().decode(event.target.value);
      log('Received: ' + value);
      if (value.includes('TEMP:')) {
        const temp = value.split(':')[1].trim();
        document.getElementById('temp').textContent = temp + ' °C';
      }
    }

    async function sendCommand(command) {
      if (!bleConnected || !rxCharacteristic) {
        log('Cannot send: BLE not connected');
        return;
      }
      try {
        const enc = new TextEncoder().encode(command);
        await rxCharacteristic.writeValue(enc);
        log('Sent: ' + command);
      } catch (err) {
        log('Send failed: ' + err);
      }
    }

    bleSwitch.addEventListener('click', () => {
      if (!bleConnected) connectBLE();
      else disconnectBLE();
    });

    document.getElementById('start').addEventListener('click', () => {
      sendCommand('START');
      document.getElementById('power').textContent = 'ON';
      document.getElementById('mode').textContent = 'RUN';
      log('Cryostat run started');
    });

    document.getElementById('stop').addEventListener('click', () => {
      sendCommand('STOP');
      document.getElementById('power').textContent = 'OFF';
      document.getElementById('mode').textContent = 'IDLE';
      log('Cryostat stopped');
    });

    document.getElementById('readTemp').addEventListener('click', () => {
      sendCommand('READ_TEMP');
      log('Requested temperature reading');
    });
  </script>
</body>
</html>
